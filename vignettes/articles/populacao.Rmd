---
title: "Estimativas populacionais por sexo e faixa etária para os municípios brasileiros, 1980 - 2024."
date: |
  | Em atualização
  <!-- | Atualizado em  -->
  | `r format(Sys.Date(), c("%d de %B de %Y"))`
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NULL
)
```

```{r setup, message=FALSE}
library(csapAIH)
library(dplyr) # facilitar o trabalho
library(Rcoisas) 
```

O Departamento de Informática do SUS (DATASUS) distribuía as estimativas e contagens populacionais por sexo e faixa etária quinquenal para os municípios brasileiros em arquivos separados por ano, desde 1980 até 2012. Após ficarmos um período sem estimativas para os anos seguintes, foi publicado no aplicativo on-line de tabulação de dados do DATASUS, o [TABNET](https://datasus.saude.gov.br/informacoes-de-saude-tabnet/), o [*Estudo de estimativas populacionais para os municípios brasileiros, desagregadas por sexo e idade, 2000-2021*](http://tabnet.datasus.gov.br/cgi/IBGE/NT-POPULACAO-RESIDENTE-2000-2021.PDF), cujos resultados ainda podem ser tabulados [nessa página](http://tabnet.datasus.gov.br/cgi/deftohtm.exe?ibge/cnv/popsvsbr.def), agora com o aviso de "*população não mais em uso*", porque o Censo 2022 mostrou que os cálculos foram superestimados. Entretanto, os arquivos-fonte não eram disponibilizados, o que levou à criação do pacote [brpop](https://rfsaldanha.github.io/brpop/) e, posteriormente, da função `popbr2000_2021()`.

Com a atualização das estimativas populacionais após o Censo 2022, o DATASUS voltou a disponibilizar arquivos com as contagens e estimativas da população por sexo e idade para os municípios brasileiros. Assim, 
além das tabulações no [TABNET](http://tabnet.datasus.gov.br/cgi/deftohtm.exe?ibge/cnv/popsvs2024br.def),
podemos novamente baixar os arquivos na página de [download de arquivos](página) ou no site FTP do DATASUS, em <ftp://ftp.datasus.gov.br/dissemin/publicos/IBGE/POP/> e <ftp://ftp.datasus.gov.br/dissemin/publicos/IBGE/POPSVS/>. [Nota técnica](http://tabnet.datasus.gov.br/cgi/IBGE/NT-POPULACAO-RESIDENTE-2000-2024.PDF)

Portanto, a função `popbr2000_2021()` não é mais necessária e é mantida no pacote apenas para documentação, reprodução de resultados anteriores e eventual comparação com as estimativas atualizadas, disponíveis em `ler_popbr()` que anteriormente lia os arquivos de [1980 a 2012](ftp://ftp.datasus.gov.br/dissemin/publicos/IBGE/POP/) e agora lê as novas estimativas e medidas, disponíveis nos arquivos de [2013 a 2024](ftp://ftp.datasus.gov.br/dissemin/publicos/IBGE/POPSVS/).

## Os arquivos de população

Os arquivos são disponibilizados com registros para todos os municípios brasileiros, com estrutura um pouco diferente entre os períodos 1980-2012 e 2013-2024.

No período 1980 a 2012, a estrutura é a seguinte (veja que é a mesma estrutura para os dois anos selecionados):
```{r}
br1980 <- ler_popbr(1980)
all.equal( str(br1980), str(ler_popbr(2012)) )
```

Já de 2013 a 2024, é a seguinte (veja que também é a mesma estrutura para os dois anos selecionados):
```{r}
br2024 <- ler_popbr(2024)
all.equal( str(ler_popbr(2013)), str(br2024) )
```

No primeiro período os bancos têm `r numescrito(ncol(br1980))` variáveis, já de 2013 em diante apenas `r numescrito(ncol(br2024))`, porque estes últimos não contêm a variável ``r names(br1980)[names(br1980) %in% names(br2024) == FALSE]`` (`r levels(br1980$situacao)[1]` ou `r levels(br1980$situacao)[2]`). Além disso, a variável `fxetaria`, que tem o mesmo nome e rótulo nos dois períodos (`r attr(br1980$fxetaria, "label")`, e `r attr(br2024$fxetaria, "label")`) tampouco tem a mesma estrutura nos dois períodos. De 1980 a 2012 a "Faixa etária detalhada" se refere a essa classificação em algumas tabulações do DATASUS, em que a idade é definida anualmente até os 19 anos de idade e em faixas quinquenais até 80 anos ou mais (e mais uma categoria para ignorados, com um total de 34 categorias), enquanto nas estimativas atualizadas a "Faixa etária detalhada" é a idade em anos até 80 ou mais (81 categorias).

Vejamos novamente a variável `fxetaria`:

 - em 1980
```{r}
str(br1980$fxetaria)
br1980$fxetaria |> unique()
```

 - em 2024
```{r}
str(br2024$fxetaria)
br2024$fxetaria |> unique()
```

Assim, se queremos um banco com as estimativas para vários anos, há que se levar em conta se o período desejado inclui arquivos com diferente estrutura e em tal caso retirar a variável `situacao` e as linhas de idade ignorada (registro `I000`) das estimativas até 2012 e retirar a variável `fxetaria` de todos os bancos.


```{r}
br <- rbind(
  rbind(br1980, ler_popbr(1991), ler_popbr(2010)) %>%
    filter(fxetaria != "I000") %>% 
    select(-c(situacao, fxetaria)),
  rbind(ler_popbr(2013), ler_popbr(2022), br2024) %>% 
    select(-fxetaria)
  )
```

Uma tabela com a população por sexo e faixa etária pode ser conseguida da seguinte forma: 
```{r}
br %>% 
  filter(ano %in% c("1980", "2024"), !is.na(fxetar5)) %>% 
  group_by(ano, sexo, fxetar5) %>% 
  reframe(populacao = sum(populacao)) %>% 
  tidyr::pivot_wider(names_from = c(ano, sexo), values_from = populacao) %>% 
  mutate(tot80 = `1980_masc` + `1980_fem`,
         tot24 = `2024_masc` + `2024_fem`) %>% 
  relocate(tot80, .after = `1980_fem`) %>% 
  adissoma() %>% 
  print()
```

```{r results='hide', out.width="45%", fig.show='hold', fig.align='center'}
#| fig.alt: >
#|   Pirâmide populacional com a função plot_pir
plot_pir(br1980, local = "Brasil")
plot_pir(br2024, local = "Brasil")
```

```{r fig.alt="Pirâmide populacional"}
#| fig.alt: >
#|   Pirâmide populacional com a função ggplot_pir
ggplot_pir(br, "fxetar5", "sexo", "populacao", nsize = 2.5) +
  ggplot2::facet_wrap(vars(ano))
```

