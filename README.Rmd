---
output: github_document
bibliography: docs/pacote.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# csapAIH
Classificar Condições Sensíveis à Atenção Primária

## Apresentação

Pacote em **R** para a classificação de códigos da CID-10 (Classificação Internacional de Doenças, 10ª Revisão) segundo a Lista Brasileira de Condições Sensíveis à Atenção Primária (CSAP). É particularmente voltado ao trabalho com as bases de dados do Sistema de Informações Hospitalares do SUS, o Sistema Único de Saúde brasileiro. Tais bases (BD-SIH/SUS) contêm os "arquivos da AIH" (`RD??????.DBC`), que podem ser expandidos para o formato DBF (`RD??????.DBF`), com as informações de cada hospitalização ocorrida pelo SUS num período determinado. Assim, embora o pacote permita a classificação de qualquer listagem de códigos da CID-10, tem também algumas funcionalidades para facilitar o trabalho com os "arquivos da AIH" e, atualmente, do Sistema de Informações sobre Mortalidade (SIM).

## Justificativa

A hospitalização por CSAP é um indicador da qualidade do sistema de saúde em sua primeira instância de atenção, uma vez que a internação por tais condições ---pneumonia, infecção urinária, sarampo, diabetes etc.---  só acontecerá se houver uma falha do sistema nesse âmbito de atenção, seja por não prevenir a ocorrência da doença (caso das doenças preveníveis por vacinação, como o sarampo), não diagnosticá-la ou tratá-la a tempo (como na pneumonia ou infeccão urinária) ou por falhar no seu controle clínico (como é o caso da diabete).

O Ministério da Saúde brasileiro estabeleceu em 2008, após amplo processo de validação, uma lista com várias causas de internação hospitalar consideradas CSAP, definindo em portaria a Lista Brasileira. A Lista envolve vários códigos da CID-10 e classifica as CSAP em 19 subgrupos de causa, o que torna complexa e trabalhosa a sua decodificação. Há alguns anos o Departamento de Informática do SUS (DATASUS) incluiu em seu excelente programa de tabulação de dados TabWin a opção de tabulação por essas causas, apresentando sua frequência segundo a tabela definida pelo usuário.

Entretanto, muitas vezes a pesquisa exige a classificação de cada internação individual como uma variável na base de dados. E não conheço outro programa ou *script* (além do que tive de escrever em minha tese) que automatize esse trabalho.

## Instalação

O pacote `csapAIH` pode ser instalado no **R** de duas maneiras:
  
  * com a função `install.packages()` sobre os arquivos de instalação no [SourceForge](https://sourceforge.net/projects/csapaih/):

```{r}
install.packages("https://sourceforge.net/projects/csapaih/files/csapAIH_0.0.4.tar.gz/download", type = "source", repos = NULL) 
```
    
ou
  
  * através do pacote `remotes` sobre os arquivos-fonte da função em desenvolvimento, no [GitHub](https://github.com/fulvionedel):

```{r}
# install.packages("remotes") # desnecessário se o pacote já estiver instalado
remotes::install_github("fulvionedel/csapAIH")
```


## Conteúdo (_timeline_)

Na sua primeira versão, o pacote `csapAIH` continha apenas uma função, homônima: `csapAIH`. 

Na versão 0.0.2, foram acrescentadas as funções `descreveCSAP`, `desenhaCSAP` e `nomesgruposCSAP`, para a representação gráfica e tabular das CSAP pela lista brasileira. Esta versão também permite a leitura de arquivos da AIH em formato .DBC, sem necessidade de prévia expansão a .DBF. Isso é possível pelo uso do pacote `read.dbc`, de Daniela Petruzalek (https://cran.r-project.org/web/packages/read.dbc/index.html). 

A partir da versão 0.0.3, a função `desenhaCSAP` permite o detalhamento do gráfico por categorias de outros fatores do banco de dados, com o uso das funções `facet_wrap()` e `facet_grid()`, de `ggplot2`, e permite ainda o desenho de gráficos com as funções básicas, sem a instalação do pacote `ggplot2`. Foi ainda criada uma função para o cálculo da idade nos arquivos da AIH: a função **idadeSUS** é usada internamente por `csapAIH` e pode ser chamada pelo usuário para calcular a idade sem a necessidade de classificar as CSAP.

Na versão 0.0.4, a função `csapAIH` oferece a opção de classificação das CSAP em 20 grupos de causa, como sugerido por @Alfradique2009. As funções `desenhaCSAP` e `tabCSAP` têm um argumento para seleção do idioma dos nomes de grupos, em português (`pt`, padrão), espanhol (`es`) ou inglês (`en`). Foram criadas as funções `ler_popbr` e `popbr2000_2021` (esta sobre o pacote de @brpopref) para acesso às estimativas populacionais publicadas pelo DATASUS. 

A ajuda sobre o pacote oferece mais detalhes sobre as funções e sua evolução. Veja no [manual](https://github.com/fulvionedel/csapAIH/blob/master/docs/csapAIH_0.0.4.pdf) ou, no R, com `?'csapAIH-package'`.


## Dependências

A leitura de arquivos .DBC exige a instalação prévia do pacote `read.csap`. Sua falta não impede o funcionamento das demais funções do pacote (inclusive de leitura, mas em outro formato). A função `desenhaCSAP` tem melhor desempenho com o pacote `ggplot2` instalado, mas sua instalação não é necessária para que ela funcione.

## Exemplos de uso

```{r}
library(csapAIH)
```

### Leitura dos arquivos

 - A partir de um arquivo "RD??????.DBF" salvo no mesmo diretório da sessão de trabalho do **R**:
  
        csap <- csapAIH::csapAIH("RD??????.DBF")
 
 - A partir de um arquivo "RD??????.DBC" salvo no mesmo diretório da sessão de trabalho do **R**:
  
        csap <- csapAIH::csapAIH("RD??????.DBC")
  
 - A partir de um banco de dados com a estrutura da AIH já carregado no ambiente de trabalho:
  
        csap <- csapAIH::csapAIH(bancodedados)
  
 - A partir de uma variável com códigos da CID-10:

```{r}
variavel <- aih100$DIAG_PRINC
csap <- csapAIH::csapAIH(variavel)
head(csap)
descreveCSAP(csap)
tabCSAP(csap$grupo, lang = "es", format = TRUE)
```


### Apresentação de resultados 

**Resumo de importação de dados**

O resumo de importação é guardado como atributo do banco de dados:

```{r}
csap <- csapAIH("data-raw/RDRS1801.dbc") # cria o data.frame
attributes(csap)$resumo
```
       
**Tabela "bruta"**

```{r}
descreveCSAP(csap)
```
 
**Tabela para apresentação ou impressão (com a função `kable`, do pacote `knitr`)**

```{r}
knitr::kable(descreveCSAP(csap), align = c('l', rep('r', 3)))
```

**Gráfico**

```{r}
gr <- desenhaCSAP(csap, titulo = "auto", onde = "RS", quando = 2018)
gr
```


*Estratificado por categorias de outra variável presente no banco de dados:*

Observe que ao estratificar o gráfico mantém a ordenação por frequência da variável em seu todo, sem a estratificação, quando o argumento `ordenar = TRUE`(padrão).
  
```{r}
gr + ggplot2::facet_grid(~ sexo)

gr + ggplot2::facet_wrap(~ munres == "431490", 
                         labeller = ggplot2::as_labeller(c("FALSE" = "Interior", 
                                                           "TRUE" = "Capital")))
```


***Veja o manual do pacote em:*** 
https://github.com/fulvionedel/csapAIH/blob/master/docs/csapAIH_0.0.4.pdf


<!-- # aqui  -->


<!-- badges: start -->
<!-- badges: end -->



<!-- You'll still need to render `README.Rmd` regularly, to keep `README.md` up-to-date. `devtools::build_readme()` is handy for this. You could also use GitHub Actions to re-render `README.Rmd` every time you push. An example workflow can be found here: <https://github.com/r-lib/actions/tree/v1/examples>. -->

## Referências
